# Render Blueprint for MemoryGuard Backend
# This file can be used to deploy the entire stack with one click

services:
  # PostgreSQL Database
  - type: pserv
    name: memoryguard-db
    plan: free
    region: oregon
    databaseName: memoryguard
    databaseUser: memoryguard

  # Redis Cache
  - type: redis
    name: memoryguard-redis
    plan: free
    region: oregon
    maxmemoryPolicy: allkeys-lru

  # Backend Web Service
  - type: web
    name: memoryguard-backend
    runtime: python
    region: oregon
    plan: free
    branch: main
    rootDir: backend
    buildCommand: chmod +x build.sh && ./build.sh
    startCommand: chmod +x start.sh && ./start.sh
    healthCheckPath: /api/v1/health
    envVars:
      - key: APP_NAME
        value: MemoryGuard
      - key: APP_VERSION
        value: 0.1.0
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false
      - key: DATABASE_URL
        fromDatabase:
          name: memoryguard-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: memoryguard-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ALGORITHM
        value: HS256
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 15
      - key: REFRESH_TOKEN_EXPIRE_DAYS
        value: 7
      - key: RATE_LIMIT_PER_MINUTE
        value: 60
      - key: LOG_LEVEL
        value: INFO
      # Add these manually in Render dashboard:
      # - GOOGLE_CLIENT_ID
      # - GOOGLE_CLIENT_SECRET
      # - GEMINI_API_KEY
      # - CORS_ORIGINS

  # Celery Worker (Optional)
  - type: worker
    name: memoryguard-celery-worker
    runtime: python
    region: oregon
    plan: free
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A celery_worker worker --loglevel=info
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: memoryguard-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: memoryguard-redis
          type: redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          name: memoryguard-redis
          type: redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          name: memoryguard-redis
          type: redis
          property: connectionString
